<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copilot Session Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      width: 100%;
      text-align: center;
    }
    
    /* Focus indicators for accessibility */
    button:focus-visible,
    input:focus-visible {
      outline: 2px solid #58a6ff;
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.2);
    }
    
    h1 {
      font-size: 48px;
      margin-bottom: 10px;
      color: #58a6ff;
    }
    .subtitle {
      color: #c9d1d9;
      margin-bottom: 40px;
      font-size: 16px;
    }
    .input-group {
      background: #161b22;
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 8px;
      display: flex;
      gap: 8px;
      transition: border-color 0.2s;
    }
    .input-group:focus-within {
      border-color: #58a6ff;
    }
    .session-input {
      flex: 1;
      padding: 16px 20px;
      min-height: 44px;
      background: transparent;
      border: none;
      color: #c9d1d9;
      font-size: 16px;
      font-family: "SF Mono", Monaco, monospace;
    }
    .session-input:focus {
      outline: none;
    }
    .session-input::placeholder {
      color: #6e7681;
    }
    .view-btn {
      padding: 16px 32px;
      min-height: 44px;
      background: #238636;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .view-btn:hover {
      background: #2ea043;
      transform: scale(1.02);
    }
    .view-btn:active {
      transform: scale(0.98);
    }
    .hint {
      margin-top: 20px;
      color: #c9d1d9;
      font-size: 14px;
    }
    .hint-code {
      display: inline-block;
      background: #161b22;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: "SF Mono", Monaco, monospace;
      font-size: 13px;
      color: #58a6ff;
    }
    .recent-sessions {
      margin-top: 40px;
      text-align: left;
    }
    .recent-title {
      color: #c9d1d9;
      font-size: 14px;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .recent-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 16px;
      grid-auto-flow: dense;
    }
    .recent-item {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 12px 16px;
      color: #c9d1d9;
      text-decoration: none;
      transition: all 0.2s;
      display: block;
      min-height: 140px;
      height: auto;
      overflow: hidden;
      min-width: 0;
    }
    .recent-item:hover {
      border-color: #58a6ff;
      background: #1c2128;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.2);
    }
    .session-id {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: "SF Mono", Monaco, monospace;
      font-size: 11px;
      color: #6e7681;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
      opacity: 0.7;
    }
    .session-id-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      min-width: 0;
    }
    .session-badges {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
      margin-left: 12px;
    }
    .session-summary {
      color: #e6edf3;
      font-size: 15px;
      font-weight: 500;
      line-height: 1.5;
      margin-bottom: 12px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      word-break: break-word;
      overflow-wrap: anywhere;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .session-divider {
      height: 1px;
      background: #21262d;
      margin: 12px 0 10px 0;
    }
    .session-info {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 12px;
      font-family: "SF Mono", Monaco, monospace;
      min-width: 0;
    }
    .session-info-item {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      color: #6e7681;
    }
    .session-info-item svg {
      flex-shrink: 0;
      width: 14px;
      height: 14px;
      opacity: 0.6;
    }
    .session-info-value {
      color: #8b949e;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .session-info-item.workspace {
      flex-basis: 100%;
      min-width: 0;
    }
    .session-info-item.workspace .session-info-value {
      font-weight: 500;
    }
    
    .status-badge {
      display: inline-block;
      font-size: 14px;
      vertical-align: middle;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    .status-badge:hover {
      opacity: 1;
    }
    .status-badge.model {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }
    /* Claude - Anthropic orange/brown */
    .status-badge.model-claude {
      background: rgba(204, 120, 92, 0.15);
      color: #e8956f;
    }
    /* GPT - OpenAI green */
    .status-badge.model-gpt {
      background: rgba(16, 163, 127, 0.15);
      color: #1ec99d;
    }
    /* Gemini - Google blue */
    .status-badge.model-gemini {
      background: rgba(66, 133, 244, 0.15);
      color: #5e9aff;
    }
    /* Fallback for other models */
    .status-badge.model-other {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
    }
    .status-badge.version {
      padding: 2px 8px;
      background: rgba(234, 179, 8, 0.15);
      color: #fbbf24;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }

    /* Sessions header with import link */
    .sessions-header {
      display: flex;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 12px;
    }
    .import-link {
      color: #58a6ff;
      font-size: 14px;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s;
    }
    .import-link:hover {
      color: #79c0ff;
      text-decoration: underline;
    }
    .import-status {
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }
    .import-status.success {
      display: block;
      background: rgba(35, 134, 54, 0.15);
      border: 1px solid #238636;
      color: #3fb950;
    }
    .import-status.error {
      display: block;
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid #f85149;
      color: #ff7b72;
    }
    .import-status.loading {
      display: block;
      background: rgba(88, 166, 255, 0.15);
      border: 1px solid #58a6ff;
      color: #58a6ff;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .recent-list {
        grid-template-columns: 1fr;
      }
      .container {
        max-width: 100%;
      }
    }

    @media (min-width: 769px) and (max-width: 1200px) {
      .recent-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Load more button and loading indicator */
    .load-more-btn {
      padding: 12px 32px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #c9d1d9;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 44px;
    }
    .load-more-btn:hover {
      background: #30363d;
      border-color: #58a6ff;
      color: #58a6ff;
      transform: translateY(-1px);
    }
    .load-more-btn:active {
      transform: translateY(0);
    }
    .loading-spinner {
      color: #58a6ff;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .loading-spinner::before {
      content: '‚è≥';
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ Session Viewer</h1>
    <p class="subtitle">View GitHub Copilot session logs</p>
    
    <form id="sessionForm" onsubmit="viewSession(event)">
      <div class="input-group">
        <input 
          type="text" 
          class="session-input" 
          id="sessionInput"
          placeholder="Enter Session ID..."
          autofocus
          required
        >
        <button type="submit" class="view-btn">View</button>
      </div>
    </form>
    
    <p class="hint">
      Session ID can be found in <span class="hint-code">~/.copilot/session-state/</span>
    </p>
    
    <% if (sessions && sessions.length > 0) { %>
      <div class="recent-sessions">
        <div class="sessions-header">
          <div class="recent-title">
            Sessions
          </div>
          <a class="import-link" id="importLink">Import session from zip</a>
        </div>
        <input
          type="file"
          id="fileInput"
          name="sessionZip"
          accept=".zip"
          style="display: none;"
        >
        <div id="importStatus" class="import-status"></div>
        <div id="sessions-container"></div>

        <!-- Load more button and loading indicator -->
        <div id="load-more-section" style="text-align: center; margin-top: 20px; display: none;">
          <button id="load-more-btn" class="load-more-btn">Load More Sessions</button>
        </div>
        <div id="loading-indicator" style="text-align: center; margin-top: 20px; display: none;">
          <div class="loading-spinner">Loading more sessions...</div>
        </div>
      </div>
    <% } %>
  </div>
  
  <!-- JSON data embedded safely -->
  <script type="application/json" id="sessions-data"><%- JSON.stringify(sessions || []) %></script>
  <script type="application/json" id="meta-data"><%- JSON.stringify({ totalSessions: totalSessions || 0, hasMore: hasMore || false }) %></script>

  <script>
    // Parse JSON data safely from script tags
    const initialSessions = JSON.parse(document.getElementById('sessions-data').textContent);
    const metaData = JSON.parse(document.getElementById('meta-data').textContent);
    const totalSessionsFromServer = metaData.totalSessions;
    const hasMoreFromServer = metaData.hasMore;

    // Infinite scroll state
    let allSessions = [...initialSessions];
    let currentOffset = initialSessions.length;
    let hasMore = hasMoreFromServer;
    let isLoading = false;
    // Load more sessions
    async function loadMoreSessions() {
      if (isLoading || !hasMore) return;

      isLoading = true;
      const loadMoreBtn = document.getElementById('load-more-btn');
      const loadingIndicator = document.getElementById('loading-indicator');
      const loadMoreSection = document.getElementById('load-more-section');

      // Show loading, hide button
      loadMoreSection.style.display = 'none';
      loadingIndicator.style.display = 'block';

      try {
        const response = await fetch(`/api/sessions/load-more?offset=${currentOffset}&limit=20`);
        if (!response.ok) {
          throw new Error('Failed to load more sessions');
        }

        const data = await response.json();
        allSessions.push(...data.sessions);
        currentOffset += data.sessions.length;
        hasMore = data.hasMore;

        // Re-render all sessions
        renderAllSessions();
        updateLoadMoreButton();

      } catch (err) {
        console.error('Error loading more sessions:', err);
        // Show button again on error
        loadMoreSection.style.display = hasMore ? 'block' : 'none';
      } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
      }
    }

    // Update load more button visibility
    function updateLoadMoreButton() {
      const loadMoreSection = document.getElementById('load-more-section');
      loadMoreSection.style.display = hasMore && !isLoading ? 'block' : 'none';
    }

    // Render all sessions (grouped by date)
    function renderAllSessions() {
      const container = document.getElementById('sessions-container');
      container.innerHTML = ''; // Clear existing

      if (allSessions.length === 0) return;

      const grouped = groupSessionsByDate(allSessions);
      const sortedDates = Object.keys(grouped).sort((a, b) => b.localeCompare(a)); // Descending

      sortedDates.forEach(dateKey => {
        const dateHeader = document.createElement('div');
        dateHeader.className = 'date-group-header';
        dateHeader.textContent = formatDateHeader(grouped[dateKey][0].createdAt);
        container.appendChild(dateHeader);

        const grid = document.createElement('div');
        grid.className = 'recent-list';
        grouped[dateKey].forEach(session => {
          grid.innerHTML += renderSessionCard(session);
        });
        container.appendChild(grid);
      });
    }

    // Check if user has scrolled near bottom
    function checkScrollPosition() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const docHeight = document.documentElement.scrollHeight;

      // Load more when user is within 500px of bottom
      if (scrollTop + windowHeight >= docHeight - 500 && hasMore && !isLoading) {
        loadMoreSessions();
      }
    }

    // Throttle scroll events for performance
    let scrollTimeout;
    function throttledScroll() {
      if (scrollTimeout) return;
      scrollTimeout = setTimeout(() => {
        checkScrollPosition();
        scrollTimeout = null;
      }, 100);
    }

    function viewSession(e) {
      e.preventDefault();
      const sessionId = document.getElementById('sessionInput').value.trim();
      if (sessionId) {
        window.location.href = `/session/${sessionId}`;
      }
    }

    // File import handling
    const fileInput = document.getElementById('fileInput');
    const importLink = document.getElementById('importLink');
    const importStatus = document.getElementById('importStatus');
    
    // Click import link to select file
    importLink.addEventListener('click', (e) => {
      e.preventDefault();
      fileInput.click();
    });
    
    // Auto-upload when file is selected
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.name.endsWith('.zip')) {
        showStatus('error', '‚ùå Please select a .zip file');
        return;
      }
      
      importLink.style.pointerEvents = 'none';
      importLink.style.opacity = '0.5';
      importLink.textContent = 'Importing...';
      showStatus('loading', 'Uploading and extracting session...');
      
      try {
        const formData = new FormData();
        formData.append('sessionZip', file);
        
        const response = await fetch('/session/import', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showStatus('success', `‚úÖ Session ${result.sessionId} imported successfully!`);
          
          // Reload page after 1.5 seconds to show new session
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showStatus('error', `‚ùå Import failed: ${result.error}`);
          importLink.style.pointerEvents = 'auto';
          importLink.style.opacity = '1';
          importLink.textContent = 'Import session from zip';
        }
      } catch (err) {
        showStatus('error', `‚ùå Import failed: ${err.message}`);
        importLink.style.pointerEvents = 'auto';
        importLink.style.opacity = '1';
        importLink.textContent = 'Import session from zip';
      } finally {
        // Reset file input
        fileInput.value = '';
      }
    });
    
    function showStatus(type, message) {
      importStatus.className = `import-status ${type}`;
      importStatus.textContent = message;
    }

    // Format duration from milliseconds to human-readable format
    function formatDuration(ms) {
      if (!ms || ms < 0) return '‚Äî';
      
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      
      if (hours > 0) {
        const remainingMinutes = minutes % 60;
        return `${hours}h ${remainingMinutes}m`;
      } else if (minutes > 0) {
        const remainingSeconds = seconds % 60;
        return `${minutes}m ${remainingSeconds}s`;
      } else {
        return `${seconds}s`;
      }
    }
    
    // Format date to YYYY/MM/DD
    function formatDateHeader(dateStr) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    }
    
    // Get date key from timestamp (YYYY-MM-DD for grouping)
    function getDateKey(timestamp) {
      if (!timestamp) return 'Unknown';
      const date = new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // Group sessions by date
    function groupSessionsByDate(sessions) {
      const groups = {};
      sessions.forEach(session => {
        const dateKey = getDateKey(session.createdAt);
        if (!groups[dateKey]) {
          groups[dateKey] = [];
        }
        groups[dateKey].push(session);
      });
      return groups;
    }
    
    // Render session card HTML
    function renderSessionCard(session) {
      // Add status badges
      let badges = '';
      if (session.isImported) {
        badges += '<span class="status-badge imported" title="Imported session">üì•</span>';
      }
      if (session.hasInsight) {
        badges += '<span class="status-badge insight" title="Has Copilot Insight">üí°</span>';
      }
      // Add model and version badges
      if (session.selectedModel) {
        const modelShort = session.selectedModel.replace('claude-', '').replace('gpt-', '').replace('gemini-', '');
        let modelClass = 'model-other';
        if (session.selectedModel.includes('claude')) {
          modelClass = 'model-claude';
        } else if (session.selectedModel.includes('gpt')) {
          modelClass = 'model-gpt';
        } else if (session.selectedModel.includes('gemini')) {
          modelClass = 'model-gemini';
        }
        badges += `<span class="status-badge model ${modelClass}" title="Model: ${escapeHtml(session.selectedModel)}">${escapeHtml(modelShort)}</span>`;
      }
      if (session.copilotVersion) {
        badges += `<span class="status-badge version" title="Copilot CLI version">${escapeHtml(session.copilotVersion)}</span>`;
      }
      
      let summaryHtml = '';
      if (session.summary && session.summary !== 'No summary' && session.summary !== 'Legacy session') {
        summaryHtml = `<div class="session-summary">${escapeHtml(session.summary)}</div>`;
      } else {
        summaryHtml = '<div class="session-summary" style="color: #6e7681; font-style: italic;">No summary available</div>';
      }
      
      let workspaceHtml = '';
      if (session.workspace && session.workspace.cwd) {
        workspaceHtml = `
          <div class="session-info-item workspace" title="${escapeHtml(session.workspace.cwd)}">
            <svg viewBox="0 0 16 16" fill="currentColor"><path d="M1.75 1A1.75 1.75 0 000 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0016 13.25v-8.5A1.75 1.75 0 0014.25 3H7.5a.25.25 0 01-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75z"></path></svg>
            <span class="session-info-value">${escapeHtml(session.workspace.cwd)}</span>
          </div>
        `;
      }
      
      const createdAtStr = session.createdAt 
        ? new Date(session.createdAt).toLocaleString('en-US', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false })
        : 'unknown';
      
      let durationHtml = '';
      if (session.duration) {
        durationHtml = `
          <div class="session-info-item">
            <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM7.25 12.5v-5A.75.75 0 0 1 8 6.75h2.5a.75.75 0 0 1 0 1.5H8.75v4.25a.75.75 0 0 1-1.5 0Z"></path></svg>
            <span class="session-info-value">${formatDuration(session.duration)}</span>
          </div>
        `;
      }
      
      return `
        <a href="/session/${session.id}" class="recent-item">
          <div class="session-id">
            <span class="session-id-text" title="${escapeHtml(session.id)}">${escapeHtml(session.id)}</span>
            <div class="session-badges">${badges}</div>
          </div>
          ${summaryHtml}
          <div class="session-divider"></div>
          <div class="session-info">
            ${workspaceHtml}
            <div class="session-info-item">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm7-3.25v2.992l2.028.812a.75.75 0 0 1-.557 1.392l-2.5-1A.751.751 0 0 1 7 8.25v-3.5a.75.75 0 0 1 1.5 0Z"></path></svg>
              <span class="session-info-value">${createdAtStr}</span>
            </div>
            ${durationHtml}
            <div class="session-info-item">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M7.72.72a.75.75 0 0 1 1.06 0l1.5 1.5a.75.75 0 0 1-1.06 1.06l-.22-.22v1.69a.75.75 0 0 1-1.5 0V3.06l-.22.22a.75.75 0 0 1-1.06-1.06ZM2 7a.75.75 0 0 0 0 1.5h3.69l-.22.22a.75.75 0 1 0 1.06 1.06l1.5-1.5a.75.75 0 0 0 0-1.06l-1.5-1.5a.75.75 0 0 0-1.06 1.06l.22.22Zm8.53-.28a.75.75 0 0 0 0 1.06l1.5 1.5a.75.75 0 1 0 1.06-1.06l-.22-.22H16a.75.75 0 0 0 0-1.5h-3.13l.22-.22a.75.75 0 0 0-1.06-1.06ZM7.72 12.22a.75.75 0 0 1 1.06 0l1.5 1.5a.75.75 0 1 1-1.06 1.06l-.22-.22v1.69a.75.75 0 0 1-1.5 0v-1.69l-.22.22a.75.75 0 0 1-1.06-1.06Z"></path></svg>
              <span class="session-info-value">${session.eventCount || 0} events</span>
            </div>
          </div>
        </a>
      `;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Render grouped sessions
    document.addEventListener('DOMContentLoaded', function() {
      // Initial render
      renderAllSessions();
      updateLoadMoreButton();

      // Add scroll listener for infinite scroll
      window.addEventListener('scroll', throttledScroll);

      // Add click listener for load more button
      document.getElementById('load-more-btn').addEventListener('click', loadMoreSessions);
    });
  </script>
  
  <style>
    .date-group-header {
      color: #58a6ff;
      font-size: 18px;
      font-weight: 600;
      margin-top: 32px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #21262d;
    }
    .date-group-header:first-child {
      margin-top: 0;
    }
  </style>
</body>
</html>
